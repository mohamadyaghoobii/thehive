#!/bin/bash
# Full wipe of TheHive / Cortex / Elasticsearch / Cassandra environment
# WARNING: DESTRUCTIVE OPERATION

set -euo pipefail

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

log_info()  { echo -e "${GREEN}[INFO]${NC}  $1"; }
log_warn()  { echo -e "${YELLOW}[WARN]${NC}  $1"; }
log_error() { echo -e "${RED}[FAIL]${NC}  $1"; }

confirm() {
    if [[ "${FORCE:-0}" == "1" ]]; then
        log_warn "FORCE=1 set, skipping confirmation."
        return 0
    fi

    echo -e "${RED}WARNING: This script will COMPLETELY REMOVE TheHive / Cortex / Elasticsearch / Cassandra.${NC}"
    echo -e "${RED}All data, configs, and logs will be DELETED.${NC}"
    read -rp "Type YES to continue: " ans
    [[ "$ans" == "YES" ]] || { log_warn "Aborted."; exit 1; }
}

stop_and_disable_services() {
    log_info "Stopping and disabling services..."

    for svc in thehive cortex elasticsearch cassandra; do
        if systemctl list-unit-files | grep -q "^${svc}.service"; then
            log_info "Stopping: ${svc}"
            systemctl stop "${svc}" 2>/dev/null || true
            log_info "Disabling: ${svc}"
            systemctl disable "${svc}" 2>/dev/null || true
            systemctl reset-failed "${svc}" 2>/dev/null || true
            systemctl mask "${svc}" 2>/dev/null || true
        fi
    done
}

kill_ports() {
    log_info "Killing processes on ports 9000, 9001, 9200, 9042..."

    for port in 9000 9001 9200 9042; do
        pids=$(ss -lntp 2>/dev/null \
            | awk -v p=":${port}" '$4 ~ p {print $NF}' \
            | sed -n 's/.*pid=\([0-9]\+\).*/\1/p' \
            | sort -u || true)

        if [[ -n "${pids:-}" ]]; then
            log_warn "Port ${port} in use by: ${pids} -> killing..."
            kill -9 $pids 2>/dev/null || true
        fi
    done
}

purge_packages() {
    log_info "Detecting and purging related packages..."

    pkgs=$(dpkg -l 2>/dev/null \
        | awk '/thehive|cortex|elasticsearch|cassandra/ && $1 ~ /^(ii|rc)$/ {print $2}' || true)

    if [[ -n "${pkgs:-}" ]]; then
        log_info "Purging: ${pkgs}"
        DEBIAN_FRONTEND=noninteractive apt-get purge -y $pkgs || true
        DEBIAN_FRONTEND=noninteractive apt-get autoremove --purge -y || true
    else
        log_info "No related packages installed."
    fi
}

remove_dirs() {
    log_info "Removing directories..."

    rm -rf /etc/thehive \
           /etc/cortex \
           /opt/thehive \
           /opt/thp/thehive \
           /opt/cortex \
           /var/log/thehive \
           /var/log/cortex \
           /var/lib/thehive \
           /var/lib/cortex \
           /var/lib/elasticsearch \
           /var/log/elasticsearch \
           /var/lib/cassandra \
           /var/log/cassandra \
           /tmp/thehive_* \
           /tmp/cortex_* \
           /tmp/thehive*.deb \
           /tmp/cortex*.deb
}

remove_systemd_units() {
    log_info "Removing systemd unit files..."

    rm -f /etc/systemd/system/thehive.service \
          /etc/systemd/system/cortex.service

    systemctl daemon-reload || true
}

remove_helper_scripts() {
    log_info "Removing helper scripts..."

    rm -f /usr/local/bin/check-thehive-status \
          /root/configure-integration.sh \
          /root/thehive-installation-summary.txt
}

remove_repos() {
    log_info "Removing APT repo definitions..."

    rm -f /etc/apt/sources.list.d/elasticsearch-7.x.list \
          /etc/apt/sources.list.d/thehive*.list \
          /etc/apt/sources.list.d/strangebee*.list

    log_info "Repository files removed."
}

update_apt_cache() {
    log_info "Running apt-get update..."
    apt-get update || true
}

post_checks() {
    echo ""
    log_info "Post-wipe verification..."

    dpkg -l | egrep 'thehive|cortex|elasticsearch|cassandra' \
        || echo "No related packages installed"

    systemctl list-unit-files | egrep 'thehive|cortex|elasticsearch|cassandra' \
        || echo "No related systemd unit files"

    ls -ld /etc/thehive /etc/cortex /opt/thehive /opt/thp/thehive /opt/cortex \
           /var/log/thehive /var/log/cortex \
           /var/lib/elasticsearch /var/log/elasticsearch \
           /var/lib/cassandra /var/log/cassandra 2>&1 \
        | sed 's/^/LS: /' || true

    ss -lntp | egrep '(:9000|:9001|:9200|:9042)' \
        || echo "No processes listening on target ports"

    grep -Rni 'thehive-project.org' /etc/apt/sources.list /etc/apt/sources.list.d 2>/dev/null \
        || echo "No TheHive APT entries found"

    echo ""
}

final_message() {
    echo ""
    echo "============================================="
    echo "  TheHive / Cortex / Elasticsearch / Cassandra WIPED"
    echo "============================================="
    echo "Cleanup completed."
    echo ""
}

main() {
    if [[ $EUID -ne 0 ]]; then
        log_error "Run as root."
        exit 1
    fi

    confirm
    stop_and_disable_services
    kill_ports
    purge_packages
    remove_dirs
    remove_systemd_units
    remove_helper_scripts
    remove_repos
    update_apt_cache
    post_checks
    final_message
}

main "$@"
