#!/bin/bash
# Full wipe of TheHive / Cortex / Elasticsearch / Cassandra environment
# âš  WARNING: This is DESTRUCTIVE and will remove packages, data, configs, logs.

set -euo pipefail

# ---------- Colors & logging helpers ----------
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

log_info()  { echo -e "${GREEN}[INFO]${NC}  $1"; }
log_warn()  { echo -e "${YELLOW}[WARN]${NC}  $1"; }
log_error() { echo -e "${RED}[FAIL]${NC}  $1"; }

# ---------- User confirmation ----------
confirm() {
    # If FORCE=1 is exported in the environment, skip the interactive prompt
    if [[ "${FORCE:-0}" == "1" ]]; then
        log_warn "FORCE=1 is set, skipping confirmation prompt."
        return 0
    fi

    echo -e "${RED}WARNING: This script will COMPLETELY REMOVE TheHive / Cortex / Elasticsearch / Cassandra.${NC}"
    echo -e "${RED}All databases, indices, logs, and configuration files will be DELETED.${NC}"
    read -rp "Type YES to continue: " ans
    if [[ "$ans" != "YES" ]]; then
        log_warn "Aborted by user."
        exit 1
    fi
}

# ---------- Stop and disable services ----------
stop_and_disable_services() {
    log_info "Stopping and disabling systemd services (thehive, cortex, elasticsearch, cassandra)..."

    for svc in thehive cortex elasticsearch cassandra; do
        if systemctl list-unit-files | grep -q "^${svc}.service"; then
            log_info "Stopping service: ${svc}"
            systemctl stop "${svc}" 2>/dev/null || true
            log_info "Disabling service: ${svc}"
            systemctl disable "${svc}" 2>/dev/null || true
        fi
    done
}

# ---------- Kill any processes listening on well-known ports ----------
kill_ports() {
    log_info "Killing any processes listening on ports 9000, 9001, 9200, 9042..."

    for port in 9000 9001 9200 9042; do
        local pids
        # Extract PIDs from ss output
        pids=$(ss -lntp 2>/dev/null | awk -v p=":${port}" '$4 ~ p {print $NF}' \
            | sed -n 's/.*pid=\([0-9]\+\).*/\1/p' | sort -u || true)
        if [[ -n "${pids:-}" ]]; then
            log_warn "Port ${port} is in use by PIDs: ${pids} -> sending SIGKILL..."
            kill -9 $pids 2>/dev/null || true
        fi
    done
}

# ---------- Purge apt packages ----------
purge_packages() {
    log_info "Purging TheHive, Cortex, Elasticsearch, and Cassandra packages via apt..."

    # Ignore errors if a package is not installed
    apt-get purge -y thehive cortex elasticsearch cassandra 2>/dev/null || true

    log_info "Running apt-get autoremove..."
    apt-get autoremove -y || true
}

# ---------- Remove data, config, and log directories ----------
remove_dirs() {
    log_info "Removing TheHive & Cortex configs, data, logs, and binaries..."

    # TheHive / Cortex configs, binaries, data, logs
    rm -rf /etc/thehive \
           /etc/cortex \
           /opt/thehive \
           /opt/thp/thehive \
           /opt/cortex \
           /var/log/thehive \
           /var/log/cortex

    log_info "Removing Elasticsearch data and logs..."
    rm -rf /var/lib/elasticsearch \
           /var/log/elasticsearch

    log_info "Removing Cassandra data and logs..."
    rm -rf /var/lib/cassandra \
           /var/log/cassandra

    log_info "Cleaning temporary TheHive/Cortex .deb files from /tmp..."
    rm -rf /tmp/thehive_* \
           /tmp/cortex_* \
           /tmp/thehive*.deb \
           /tmp/cortex*.deb

    log_info "Main directories removed."
}

# ---------- Remove custom systemd unit files ----------
remove_systemd_units() {
    log_info "Removing custom systemd unit files for TheHive and Cortex..."

    rm -f /etc/systemd/system/thehive.service \
          /etc/systemd/system/cortex.service

    systemctl daemon-reload || true
}

# ---------- Remove helper scripts and summaries ----------
remove_helper_scripts() {
    log_info "Removing helper scripts and installation summaries..."

    rm -f /usr/local/bin/check-thehive-status \
          /root/configure-integration.sh \
          /root/thehive-installation-summary.txt
}

# ---------- Remove related APT repository files ----------
remove_repos() {
    log_info "Removing APT repo definitions related to Elastic / Strangebee / TheHive (if present)..."

    # Elastic 7.x repo that may have been added by deploy script
    rm -f /etc/apt/sources.list.d/elasticsearch-7.x.list

    # Possible TheHive / Strangebee repos (if they exist)
    rm -f /etc/apt/sources.list.d/thehive*.list \
          /etc/apt/sources.list.d/strangebee*.list

    # Optional: clean legacy GPG keyring for Elasticsearch if desired
    # (only if you are sure you don't need it for anything else)
    # rm -f /usr/share/keyrings/elasticsearch-keyring.gpg || true

    log_info "APT repo entries removed (where present)."
}

# ---------- Update apt cache after repo changes ----------
update_apt_cache() {
    log_info "Running apt-get update after repository cleanup..."
    apt-get update || log_warn "apt-get update returned non-zero (you can ignore if not using these repos anymore)."
}

# ---------- Final status message ----------
final_message() {
    echo ""
    echo "============================================="
    echo "  TheHive / Cortex / ES / Cassandra WIPED"
    echo "============================================="
    echo "Everything related to this stack has been removed:"
    echo "  - Packages (where installed)"
    echo "  - Configs under /etc"
    echo "  - Data under /var/lib"
    echo "  - Logs under /var/log"
    echo "  - Custom systemd units"
    echo "  - Helper scripts & summary"
    echo "You are now ready to run your fresh deploy.sh."
    echo ""
}

# ---------- Main ----------
main() {
    if [[ $EUID -ne 0 ]]; then
        log_error "This script must be run as root."
        exit 1
    fi

    confirm
    stop_and_disable_services
    kill_ports
    purge_packages
    remove_dirs
    remove_systemd_units
    remove_helper_scripts
    remove_repos
    update_apt_cache
    final_message
}

main "$@"


dpkg -l | egrep 'thehive|cortex|elasticsearch|cassandra' || echo "No related packages installed"


systemctl list-unit-files | egrep 'thehive|cortex|elasticsearch|cassandra' || echo "No related systemd unit files"


ls -ld /etc/thehive /etc/cortex /opt/thehive /opt/thp/thehive /opt/cortex /var/log/thehive /var/log/cortex /var/lib/elasticsearch /var/log/elasticsearch /var/lib/cassandra /var/log/cassandra 2>&1 | sed 's/^/LS: /'


ss -lntp | egrep '(:9000|:9001|:9200|:9042)' || echo "No processes listening on 9000/9001/9200/9042"


grep -Rni 'thehive-project.org' /etc/apt/sources.list /etc/apt/sources.list.d 2>/dev/null
